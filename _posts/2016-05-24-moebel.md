---
layout: post
title:  "Moebel TV Ads Effectiveness on Digital Campaigns"
date:   2016-05-24 09:54:31
categories: science
---



## Click through rate improvement
The table below shows the improvement of click through rate during hours with more TV ads than hours with fewer TV ads.

<--html_preserve--><div id="htmlwidget-2815" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2815">{"x":{"data":[["1","2","3"],["moebel","IKEA","both"],[0.306335555555234,0.0961227434140738,0.0689334051854651],[0.0989674671397481,0.00163074566158595,0.0293807450362851]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> \u003c/th>\n      <th>Brand\u003c/th>\n      <th>Average CTR Improvement\u003c/th>\n      <th>Combined CTR Improvement\u003c/th>\n    \u003c/tr>\n  \u003c/thead>\n\u003c/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"rowCallback":"function(row, data) {\nvar d = parseFloat(data[2]); $(this.api().cell(row, 2).node()).html(isNaN(d) ? '' : (d * 100).toFixed(2) + '%');\nvar d = parseFloat(data[3]); $(this.api().cell(row, 3).node()).html(isNaN(d) ? '' : (d * 100).toFixed(2) + '%');\n}"},"callback":null,"filter":"none"},"evals":["options.rowCallback"],"jsHooks":[]}</script><--/html_preserve-->

<div id="htmlwidget-745" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-745">{"x":{"data":[["1","2","3"],["moebel","IKEA","both"],[0.306335555555234,0.0961227434140738,0.0689334051854651],[0.0989674671397481,0.00163074566158595,0.0293807450362851]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> \u003c/th>\n      <th>Brand\u003c/th>\n      <th>Average CTR Improvement\u003c/th>\n      <th>Combined CTR Improvement\u003c/th>\n    \u003c/tr>\n  \u003c/thead>\n\u003c/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"rowCallback":"function(row, data) {\nvar d = parseFloat(data[2]); $(this.api().cell(row, 2).node()).html(isNaN(d) ? '' : (d * 100).toFixed(2) + '%');\nvar d = parseFloat(data[3]); $(this.api().cell(row, 3).node()).html(isNaN(d) ? '' : (d * 100).toFixed(2) + '%');\n}"},"callback":null,"filter":"none"},"evals":["options.rowCallback"],"jsHooks":[]}</script>


Note:

Each line is a different scenario. The first line is the CTR improvement when only Moebel's ads are runing on TV. The second line is the CTR improvement when only IKEA's ads are runing on TV. The third line is when both ads are running on TV.

The column "Average CTR Improvement" calculated the CTR of each hour by averaging the CTR of that hour in each day. The column "Combined CTR Improvement" calculates the CTR of each hour by dividing the total of clicks by the total of impressions of that hour in each day.



## Script

### Define function to read and lightly process ad occurrence data

```r
read_ttx = function(path) {
  ad_vars = c("datetime", "channel", "company", "brand", "product", "category", "asset_type", "duration", "program", "affiliation", "country")
  out_data = fread(path, col.names = ad_vars) %>%
    mutate(duration = as.numeric(substr(duration, 2, 3)), 
           datetime = ymd_hms(datetime)) %>%
    select(datetime, channel, brand, duration, program, country)
  return(out_data)
}
```

### Read data
Read and combine ad occrrence data of IKEA and Moebel.

```r
ttx_ads = bind_rows(read_ttx("~/Desktop/moebel/ikea_ads.csv"), read_ttx("~/Desktop/moebel/moebel_ads.csv")) %>%
  arrange(datetime) %>%
  mutate(datehour = substr(datetime, 1, 13)) %>%
  group_by(datehour, brand) %>%
  summarise(duration = sum(duration, na.rm = TRUE))
```

Read campaign metrics data and calculate click through rate

```r
campnum = fread("~/Desktop/moebel/campaign_metrics.csv") %>%
  mutate(datetime = ymd_hms(datetime), 
         ctr = clicks / impressions, 
         datehour = substr(datetime, 1, 13))
```

### Merge campaign metrcis and ad occurrence data, and analyze
Define function that merges and calculates the avergae improvement

```r
synccamp = function(campaign, ttx, brands = "both", ctr_method = "sum/sum") {
  which_brand = ifelse(toupper(brands) %in% c("IKEA", "MOEBEL"), ifelse(toupper(brands) == "MOEBEL", "IKEA", "moebel.de"), "")
  moik = full_join(campaign, ttx %>% filter(brand != which_brand), by = "datehour") %>%
    group_by(datehour) %>%
    summarise(tvad = sum(duration, na.rm = TRUE), 
              ctr = ifelse(ctr_method == "avg", mean(ctr, na.rm = TRUE), sum(clicks, na.rm = TRUE) / sum(impressions, na.rm = TRUE))) %>%
    mutate(hour = substr(datehour, 12, 13))
  
  xx = c()
  for (anhour in unique(moik$hour)) {
    temp_data = filter(moik, hour == anhour)
    temp_data$moreads = ifelse(temp_data$tvad > median(temp_data$tvad), "More", "Less")
    if (length(unique(temp_data$moreads)) == 1 | min(table(temp_data$moreads)) < 2) next
    fit = t.test(ctr ~ moreads, data = temp_data, na.rm = T)
    # if (fit$p.value < 0.05) {
    xx = c(xx, as.numeric((fit$estimate[2]-fit$estimate[1])/fit$estimate[1]))
    # }
  }
  return(mean(xx))
}
```

Create the table for final output including all three scenarios

```r
moebel_out = expand.grid(brands = c("moebel", "IKEA", "both"), ctr_method = c("avg", "sum/sum"), improvement = NA)
for (i in 1:nrow(moebel_out)) moebel_out$improvement[i] = synccamp(campnum, ttx_ads, moebel_out$brands[i], moebel_out$ctr_method[i])
moebel_out = dcast(moebel_out, brands ~ ctr_method, value.var = "improvement")
names(moebel_out) = c("Brand", "Average CTR Improvement", "Combined CTR Improvement")
DT::datatable(moebel_out) %>% formatPercentage(c("Average CTR Improvement", "Combined CTR Improvement"), 2)
```
